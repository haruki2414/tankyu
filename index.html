<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Firebase åœ°å›³æ²ç¤ºæ¿</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; }

  #auth {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    z-index: 1000;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }

  textarea {
    width: 200px;
    height: 80px;
  }
</style>
</head>
<body>

<div id="auth">
  <h3>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</p>
</div>

<div id="map"></div>

<script>
/* ğŸ”¥ Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyCe_0TVZeUqhxjd7UFflZ-dUamIehU7KWA",
  authDomain: "tankyu-6db3a.firebaseapp.com",
  projectId: "tankyu-6db3a",
  storageBucket: "tankyu-6db3a.firebasestorage.app",
  messagingSenderId: "127226146209",
  appId: "1:127226146209:web:8b20840d3a325191c86fe0"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;

/* ğŸ‘¤ èªè¨¼çŠ¶æ…‹ç›£è¦– */
auth.onAuthStateChanged(user => {
  const info = document.getElementById("userInfo");
  if (user) {
    currentUser = user;
    info.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}`;
  } else {
    currentUser = null;
    info.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“";
  }
});

/* ğŸ”‘ æ–°è¦ç™»éŒ² */
function signup() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.createUserWithEmailAndPassword(email, password)
    .then(() => alert("æ–°è¦ç™»éŒ²æˆåŠŸï¼"))
    .catch(e => alert(e.message));
}

/* ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³ */
function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.signInWithEmailAndPassword(email, password)
    .then(() => alert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼"))
    .catch(e => alert(e.message));
}

/* ğŸ—ºï¸ åœ°å›³ */
const map = L.map("map").setView([36.3659, 140.4710], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

/* ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ç®¡ç† */
const markers = {};

/* ğŸ“¥ æŠ•ç¨¿è¡¨ç¤ºï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
db.collection("posts").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const docId = change.doc.id;

    if (change.type === "added") {
      const data = change.doc.data();

      let popupContent = `<p>${data.text}</p>`;

      // ğŸ‘¤ è‡ªåˆ†ã®æŠ•ç¨¿ã ã‘å‰Šé™¤å¯èƒ½
      if (currentUser && data.uid === currentUser.uid) {
        popupContent += `
          <button onclick="deletePost('${docId}')">
            å‰Šé™¤
          </button>
        `;
      }

      const marker = L.marker([data.lat, data.lng])
        .addTo(map)
        .bindPopup(popupContent);

      markers[docId] = marker;
    }

    if (change.type === "removed") {
      if (markers[docId]) {
        map.removeLayer(markers[docId]);
        delete markers[docId];
      }
    }
  });
});

/* ğŸ–±ï¸ åœ°å›³ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆï¼‰ */
map.on("click", e => {
  if (!currentUser) {
    alert("æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ–°è¦ç™»éŒ²ï¼‰ãŒå¿…è¦ã§ã™");
    return;
  }

  const popup = `
    <textarea id="text"></textarea><br>
    <button onclick="savePost(${e.latlng.lat}, ${e.latlng.lng})">
      æŠ•ç¨¿
    </button>
  `;
  L.popup()
    .setLatLng(e.latlng)
    .setContent(popup)
    .openOn(map);
});

/* ğŸ’¾ æŠ•ç¨¿ä¿å­˜ */
function savePost(lat, lng) {
  if (!currentUser) return;

  const text = document.getElementById("text").value;
  if (!text) return;

  db.collection("posts").add({
    lat: lat,
    lng: lng,
    text: text,
    uid: currentUser.uid,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  map.closePopup();
}

/* ğŸ—‘ï¸ æŠ•ç¨¿å‰Šé™¤ï¼ˆæœ¬äººã®ã¿ï¼‰ */
function deletePost(postId) {
  if (!currentUser) return;

  if (!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  db.collection("posts").doc(postId).delete()
    .catch(e => alert("å‰Šé™¤ã§ãã¾ã›ã‚“"));
}
</script>

</body>
</html>
