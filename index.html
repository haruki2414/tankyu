<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Firebase åœ°å›³æ²ç¤ºæ¿</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; }

  #auth {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    z-index: 1000;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }

  textarea {
    width: 220px;
    height: 80px;
  }

  .time {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
  }

  button {
    margin-top: 4px;
  }
</style>
</head>
<body>

<div id="auth">
  <h3>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h3>
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</p>
</div>

<div id="map"></div>

<script>
/* ğŸ”¥ Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyCe_0TVZeUqhxjd7UFflZ-dUamIehU7KWA",
  authDomain: "tankyu-6db3a.firebaseapp.com",
  projectId: "tankyu-6db3a",
  storageBucket: "tankyu-6db3a.firebasestorage.app",
  messagingSenderId: "127226146209",
  appId: "1:127226146209:web:8b20840d3a325191c86fe0"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();
let currentUser = null;

/* ğŸ‘¤ èªè¨¼çŠ¶æ…‹ç›£è¦– */
auth.onAuthStateChanged(user => {
  const info = document.getElementById("userInfo");
  if (user) {
    currentUser = user;
    info.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.email}`;
  } else {
    currentUser = null;
    info.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“";
  }
});

/* ğŸ”‘ æ–°è¦ç™»éŒ² */
function signup() {
  auth.createUserWithEmailAndPassword(email.value, password.value)
    .catch(e => alert(e.message));
}

/* ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³ */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e => alert(e.message));
}

/* ğŸ—ºï¸ åœ°å›³ */
const map = L.map("map").setView([36.3659, 140.4710], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

/* ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ç®¡ç† */
const markers = {};

/* ğŸ•’ æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•° */
function formatDate(timestamp) {
  if (!timestamp) return "";
  const d = timestamp.toDate();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const h = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  return `${y}/${m}/${day} ${h}:${min}`;
}

/* ğŸ“¥ æŠ•ç¨¿è¡¨ç¤ºï¼ˆæ—¥æ™‚ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ */
db.collection("posts").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const id = change.doc.id;

    if (change.type === "added" || change.type === "modified") {
      const d = change.doc.data();

      if (markers[id]) map.removeLayer(markers[id]);

      let popup = `
        <p>${d.text}</p>
        <div class="time">ğŸ•’ ${formatDate(d.createdAt)}</div>
      `;

      if (currentUser && d.uid === currentUser.uid) {
        popup += `
          <button onclick="openEdit('${id}', '${d.text.replace(/'/g,"&#39;")}')">ç·¨é›†</button>
          <button onclick="deletePost('${id}')">å‰Šé™¤</button>
        `;
      }

      const marker = L.marker([d.lat, d.lng])
        .addTo(map)
        .bindPopup(popup);

      markers[id] = marker;
    }

    if (change.type === "removed") {
      if (markers[id]) {
        map.removeLayer(markers[id]);
        delete markers[id];
      }
    }
  });
});

/* ğŸ–±ï¸ æŠ•ç¨¿ */
map.on("click", e => {
  if (!currentUser) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
    return;
  }

  const popup = `
    <textarea id="newText"></textarea><br>
    <button onclick="savePost(${e.latlng.lat}, ${e.latlng.lng})">æŠ•ç¨¿</button>
  `;
  L.popup().setLatLng(e.latlng).setContent(popup).openOn(map);
});

/* ğŸ’¾ æ–°è¦æŠ•ç¨¿ */
function savePost(lat, lng) {
  const text = document.getElementById("newText").value;
  if (!text) return;

  db.collection("posts").add({
    lat,
    lng,
    text,
    uid: currentUser.uid,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  map.closePopup();
}

/* âœï¸ ç·¨é›† */
function openEdit(id, text) {
  const popup = `
    <textarea id="editText">${text}</textarea><br>
    <button onclick="updatePost('${id}')">ä¿å­˜</button>
  `;
  markers[id].bindPopup(popup).openPopup();
}

/* ğŸ’¾ æ›´æ–°ï¼ˆæ—¥æ™‚ã¯å¤‰æ›´ã—ãªã„ï¼‰ */
function updatePost(id) {
  const text = document.getElementById("editText").value;
  if (!text) return;

  db.collection("posts").doc(id).update({ text });
}

/* ğŸ—‘ï¸ å‰Šé™¤ */
function deletePost(id) {
  if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  db.collection("posts").doc(id).delete();
}
</script>

</body>
</html>
