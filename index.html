<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Firebase åœ°å›³æ²ç¤ºæ¿ï¼ˆç·¨é›†æ©Ÿèƒ½ã‚ã‚Šï¼‰</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
  body { margin: 0; font-family: sans-serif; }
  #map { height: 100vh; }

  #auth {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px;
    z-index: 1000;
    border-radius: 6px;
    box-shadow: 0 0 5px rgba(0,0,0,.3);
  }

  textarea { width: 220px; height: 80px; }
  .nickname { font-weight: bold; }
  .time { font-size: 12px; color: #666; }
</style>
</head>
<body>

<div id="auth">
  <input id="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«"><br>
  <input id="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><br>
  <input id="nicknameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆåˆå›ï¼‰"><br>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="signup()">æ–°è¦ç™»éŒ²</button>
  <p id="userInfo">æœªãƒ­ã‚°ã‚¤ãƒ³</p>
</div>

<div id="map"></div>

<script>
/* Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "AIzaSyCe_0TVZeUqhxjd7UFflZ-dUamIehU7KWA",
  authDomain: "tankyu-6db3a.firebaseapp.com",
  projectId: "tankyu-6db3a",
  messagingSenderId: "127226146209",
  appId: "1:127226146209:web:8b20840d3a325191c86fe0"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

const ADMIN_EMAIL = "icj210209@gmail.com";

let currentUser = null;
let currentNickname = "";
let isAdmin = false;

/* èªè¨¼çŠ¶æ…‹ç›£è¦– */
auth.onAuthStateChanged(async user => {
  const info = document.getElementById("userInfo");

  if (!user) {
    currentUser = null;
    isAdmin = false;
    info.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return;
  }

  currentUser = user;
  isAdmin = user.email === ADMIN_EMAIL;

  const doc = await db.collection("users").doc(user.uid).get();
  currentNickname = doc.exists ? doc.data().nickname : "åç„¡ã—";

  info.textContent = isAdmin
    ? "ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ä¸­"
    : `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${currentNickname}`;
});

/* æ–°è¦ç™»éŒ² */
async function signup() {
  if (!nicknameInput.value) {
    alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const res = await auth.createUserWithEmailAndPassword(
    email.value, password.value
  );

  await db.collection("users").doc(res.user.uid).set({
    nickname: nicknameInput.value
  });
}

/* ãƒ­ã‚°ã‚¤ãƒ³ */
function login() {
  auth.signInWithEmailAndPassword(email.value, password.value);
}

/* åœ°å›³ */
const map = L.map("map").setView([36.3659, 140.4710], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const markers = {};

/* æ—¥æ™‚æ•´å½¢ */
function formatDate(ts) {
  if (!ts) return "";
  const d = ts.toDate();
  return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,"0")}`;
}

/* æŠ•ç¨¿è¡¨ç¤º */
db.collection("posts").onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const id = change.doc.id;

    if (change.type === "added" || change.type === "modified") {
      if (markers[id]) map.removeLayer(markers[id]);

      const d = change.doc.data();

      let popup = `
        <div class="nickname">${d.nickname}</div>
        <div class="time">ğŸ•’ ${formatDate(d.createdAt)}</div>
        <p>${d.text}</p>
      `;

      // æœ¬äººï¼šç·¨é›†ï¼‹å‰Šé™¤
      if (currentUser && d.uid === currentUser.uid) {
        popup += `
          <button onclick="editPost('${id}', '${d.text.replace(/'/g,"\\'")}')">
            ç·¨é›†
          </button>
          <button onclick="deletePost('${id}')">
            å‰Šé™¤
          </button>
        `;
      }

      // ç®¡ç†è€…ï¼šå‰Šé™¤ã®ã¿
      if (currentUser && isAdmin && d.uid !== currentUser.uid) {
        popup += `
          <button onclick="deletePost('${id}')">
            ç®¡ç†è€…å‰Šé™¤
          </button>
        `;
      }

      markers[id] = L.marker([d.lat, d.lng])
        .addTo(map)
        .bindPopup(popup);
    }

    if (change.type === "removed" && markers[id]) {
      map.removeLayer(markers[id]);
      delete markers[id];
    }
  });
});

/* æŠ•ç¨¿ */
map.on("click", e => {
  if (!currentUser) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    return;
  }

  const popup = `
    <textarea id="text"></textarea><br>
    <button onclick="savePost(${e.latlng.lat}, ${e.latlng.lng})">
      æŠ•ç¨¿
    </button>
  `;
  L.popup().setLatLng(e.latlng).setContent(popup).openOn(map);
});

/* æŠ•ç¨¿ä¿å­˜ */
function savePost(lat, lng) {
  const text = document.getElementById("text").value;
  if (!text) return;

  db.collection("posts").add({
    lat,
    lng,
    text,
    uid: currentUser.uid,
    nickname: currentNickname,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  map.closePopup();
}

/* ç·¨é›† */
function editPost(id, oldText) {
  const newText = prompt("å†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„", oldText);
  if (newText === null || newText.trim() === "") return;

  db.collection("posts").doc(id).update({
    text: newText,
    editedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

/* å‰Šé™¤ */
function deletePost(id) {
  if (!confirm("ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  db.collection("posts").doc(id).delete();
}
</script>

</body>
</html>
